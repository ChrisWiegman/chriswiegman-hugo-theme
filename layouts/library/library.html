{{ define "main" }}
<article class="library">
  <div class="container">
    {{- $booksPage := site.GetPage "books" -}}
    {{- $books := $booksPage.Resources.ByType "page" -}}

    {{/* ---- Build normalized row model once (used by summary + list) ---- */}}
    {{- $rows := slice -}}

    {{- range $books -}}
    {{- $book := . -}}

    {{- $title := $book.Title -}}
    {{- $titleKey := lower (trim $title " ") -}}

    {{- $author := default "" $book.Params.author -}}
    {{- $authorKey := lower (trim $author " ") -}}

    {{- $rating := int (default 0 $book.Params.rating) -}}

    {{- $finishedUnix := 0 -}}
    {{- $finishedYear := "" -}}
    {{- $finishedDisplays := slice -}}
    {{- $finishedRaw := slice -}}

    {{- with $book.Params.finished -}}
    {{- if gt (len .) 0 -}}
    {{- $finishedItems := slice -}}
    {{- range . -}}
    {{- $t := time . -}}
    {{- $finishedItems = $finishedItems | append (dict
    "unix" $t.Unix
    "year" ($t.Format "2006")
    "display" ($t.Format "02 Jan, 2006")
    ) -}}
    {{- $finishedRaw = $finishedRaw | append . -}}
    {{- end -}}

    {{- $finishedItems = sort $finishedItems "unix" "desc" -}}
    {{- $finishedUnix = (index $finishedItems 0).unix -}}
    {{- $finishedYear = (index $finishedItems 0).year -}}

    {{- range $finishedItems -}}
    {{- $finishedDisplays = $finishedDisplays | append .display -}}
    {{- end -}}
    {{- end -}}
    {{- end -}}

    {{- $rows = $rows | append (dict
    "page" $book
    "title" $title
    "titleKey" $titleKey
    "author" $author
    "authorKey" $authorKey
    "rating" $rating
    "finishedUnix" $finishedUnix
    "finishedYear" $finishedYear
    "finishedDisplays" $finishedDisplays
    "finishedRaw" $finishedRaw
    ) -}}
    {{- end -}}

    <div class="content-header">
      <h1 class="title post-title p-name" itemprop="name headline">My Library</h1>
      <p class="description">My library currently contains <span class="book-count">{{ len $rows }}</span> books.</p>
    </div>

    <div class="content e-content" itemprop="articleBody">
      {{ .Content }}

      {{/* ---- Summary: books read by year (uses most recent finished date) ---- */}}
      {{- $yearCounts := dict -}}
      {{- range $rows -}}
      {{- range $raw := .finishedRaw -}}
      {{- $t := (time $raw) -}}
      {{- $y := $t.Format "2006" -}}
      {{- if ne $y "" -}}
      {{- $current := (index $yearCounts $y | default 0) -}}
      {{- $yearCounts = merge $yearCounts (dict $y (add $current 1)) -}}
      {{- end -}}
      {{- end -}}
      {{- end -}}

      {{- $yearRows := slice -}}
      {{- range $year, $count := $yearCounts -}}
      {{- $yearRows = $yearRows | append (dict "year" $year "count" $count) -}}
      {{- end -}}
      {{- $yearRows = sort $yearRows "year" "desc" -}}

      {{- if gt (len $yearRows) 0 -}}
      <section class="library-summary" aria-label="Reading summary">
        <h2 class="main-header">Reading Summary</h2>
        <div class="summary-grid">
          {{- range $yearRows -}}
          <div class="summary-card">
            <div class="summary-year">{{ .year }}</div>
            <div class="summary-count">{{ .count }}</div>
            <div class="summary-label">books</div>
          </div>
          {{- end -}}
        </div>
      </section>
      {{- end -}}

      <h2 class="main-header">All Books</h2>

      <div class="books" data-library-table>
        <div class="book-header">
          <button type="button" class="book-sort" data-sort="title" aria-sort="none">Title</button>
          <button type="button" class="book-sort" data-sort="author" aria-sort="none">Author</button>
          <button type="button" class="book-sort" data-sort="rating" aria-sort="none">Rating</button>
          <span class="book-links-header">Links</span>
          <button type="button" class="book-sort" data-sort="finished" aria-sort="none">Finished</button>
        </div>

        {{- range $rows -}}
        {{- $row := . -}}
        {{- $book := $row.page -}}

        <div class="book" data-title="{{ $row.titleKey }}" data-author="{{ $row.authorKey }}"
          data-rating="{{ $row.rating }}" data-finished="{{ $row.finishedUnix }}">
          <h3 class="book-title">{{ $row.title }}</h3>
          <span class="book-meta book-author">{{ $row.author }}</span>

          {{ partial "books/rating.html" (dict "rating" $row.rating) }}
          {{ partial "books/links.html" $book }}

          <span class="book-meta book-date">
            {{- if gt (len $row.finishedDisplays) 0 -}}
            {{- range $row.finishedDisplays -}}
            <span class="date">{{ . }}</span>
            {{- end -}}
            {{- else -}}
            <span class="date date-empty">â€”</span>
            {{- end -}}
          </span>
        </div>
        {{- end -}}
        {{ $library := resources.Get "scripts/library.js" }}
        {{ $bundle := slice $library | resources.Concat "js/library.js" }}
        {{ $js := $bundle | resources.Minify }}
        <script src="{{ $js.RelPermalink }}"></script>
      </div>
    </div>
  </div>
</article>
{{- end -}}