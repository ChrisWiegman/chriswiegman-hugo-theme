{{- $pages := .RegularPages.ByDate.Reverse -}}
{{- $limit := .Site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
{{- $pages = $pages | first $limit -}}
{{- end -}}
{{- printf "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n" | safeHTML -}}
<rss version="2.0"
    xmlns:content="http://purl.org/rss/1.0/modules/content/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
>
    <channel>
        <language>{{ site.Language.LanguageCode | default "en-US" }}</language>
        <title>{{ with .Title }}{{ . }} on {{ end }}{{ .Site.Title }}</title>
        <link>{{- .Permalink -}}</link>
        {{ with .OutputFormats.Get "RSS" -}}
            <atom:link href="{{ .Permalink }}" rel="self" type="{{ .MediaType.Type }}" />
        {{- end }}
        <atom:link href="https://pubsubhubbub.appspot.com/" rel="hub" />

        <description>{{ .Params.description }}</description>

        {{- $last := now -}}
        {{- if gt (len $pages) 0 -}}
        {{- $last = (index $pages 0).Date -}}
        {{- end -}}
        <lastBuildDate>{{ $last.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</lastBuildDate>

        <sy:updatePeriod>hourly</sy:updatePeriod>
        <sy:updateFrequency>1</sy:updateFrequency>

        {{- $paginator := .Paginate $pages -}}
        {{- $pagerSize := $paginator.PagerSize | default 10 -}}
        {{ range $index, $page := $pages }}
        <item>
            <title>{{ $page.Title }}</title>
            {{- $pageNum := add (div $index $pagerSize) 1 -}}
            {{- $pageLink := $.Permalink -}}
            {{- if gt $pageNum 1 -}}
                {{- $pageLink = printf "%spage/%d/" $pageLink $pageNum -}}
            {{- end -}}
            {{- $notesLink := printf "%s#%s" $pageLink $page.File.ContentBaseName -}}
            <link>{{- $notesLink | chomp -}}</link>
            <guid isPermaLink="false">{{ $page.File.Path }}</guid>
            <dc:creator>{{ "Chris Wiegman" | htmlEscape }}</dc:creator>
            <pubDate>{{ $page.Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</pubDate>
            {{ with $page.Site.Author.email }}<author>{{.}}{{ with $.Site.Author.name }} ({{.}}){{end}}</author>{{end}}

            {{- with $page.Summary -}}
                <description>{{ . | plainify | htmlEscape }}</description>
            {{- else -}}
                <description/>
            {{- end -}}

            {{- $base := strings.TrimSuffix "/" $page.Site.BaseURL -}}
            {{- $html := $page.Content -}}
            {{- $html = replaceRE `href="(/[^"]*)"` (printf `href="%s$1"` $base) $html -}}
            {{- $html = replaceRE `src="(/[^"]*)"`  (printf `src="%s$1"`  $base) $html -}}

            <content:encoded>{{ printf "<![CDATA[ %s ]]>" $html | safeHTML }}</content:encoded>
        </item>
        {{ end }}
    </channel>
</rss>
