{{- $main := site.Params.mainSections -}}
{{- $sections := cond (reflect.IsSlice $main) $main (slice $main) -}}
{{- $pages := (where site.RegularPages "Section" "in" $sections).ByDate.Reverse -}}
{{- $limit := .Site.Config.Services.RSS.Limit -}}
{{- if ge $limit 1 -}}
{{- $pages = $pages | first $limit -}}
{{- end -}}
{{- printf "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n" | safeHTML -}}
<rss version="2.0"
    xmlns:content="http://purl.org/rss/1.0/modules/content/"
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
>
    <channel>
        <language>{{ site.Language.LanguageCode | default "en-US" }}</language>
        <title>{{ if eq .Title .Site.Title }}{{ .Site.Title }}{{ else }}{{ with .Title }}{{.}} on {{
        end }}{{ .Site.Title }}{{ end }}</title>
        <link>{{- .Site.BaseURL -}}</link>
        {{ with .OutputFormats.Get "RSS" -}}
            <atom:link href="{{ .Permalink }}" rel="self" type="{{ .MediaType.Type }}" />
        {{- end }}
        <atom:link href="https://pubsubhubbub.appspot.com/" rel="hub" />

        <description>{{.Site.Params.Description }}</description>

        {{- $last := now -}}
        {{- if gt (len $pages) 0 -}}
        {{- $last = (index $pages 0).Date -}}
        {{- end -}}
        <lastBuildDate>{{ $last.Format "Mon, 02 Jan 2006 15:04:05 -0700" }}</lastBuildDate>

        <sy:updatePeriod>hourly</sy:updatePeriod>
        <sy:updateFrequency>1</sy:updateFrequency>

        {{ range $pages }}
        <item>
            <title>{{ .Title }}</title>
            {{- $pagePermalink := .Permalink -}}
            {{- with $featured_image := index .Params.images 0 -}}
                {{- with resources.Get $featured_image -}}
                    {{- $jpg := .Process "jpg q85" -}}
                    {{- $length := len $jpg.Content -}}
                    <enclosure url="{{ $jpg.Permalink }}" length="{{ $length }}" type="image/jpeg" />
                {{- end -}}
            {{- end -}}
            <link>{{- .Permalink | chomp -}}</link>
            <guid isPermaLink="true">{{- .Permalink | chomp -}}</guid>
            <dc:creator>{{ "Chris Wiegman" | htmlEscape }}</dc:creator>
            {{- if .Params.categories -}}
            {{- range .Params.categories }}
                <category>{{ . | htmlEscape }}</category>
            {{- end }}
            {{- end -}}
            {{- if .Params.tags -}}
            {{- range .Params.tags }}
                <category>{{ . | htmlEscape }}</category>
            {{- end }}
            {{- end -}}
            <pubDate>{{ .Date.Format "Mon, 02 Jan 2006 15:04:05 -0700" | safeHTML }}</pubDate>
            {{ with .Site.Author.email }}<author>{{.}}{{ with $.Site.Author.name }} ({{.}}){{end}}</author>{{end}}
            {{- $base := strings.TrimSuffix "/" .Site.BaseURL -}}

             {{- with .Params.description -}}
                <description>{{ . | plainify | htmlEscape }}</description>
            {{- else -}}
                <description/>
            {{- end -}}

            {{- $html := .Content -}}
            {{- $html = replaceRE `href="(/[^"]*)"` (printf `href="%s$1"` $base) $html -}}
            {{- $html = replaceRE `src="(/[^"]*)"`  (printf `src="%s$1"`  $base) $html -}}

            <content:encoded>{{ printf "<![CDATA[ %s ]]>" $html | safeHTML }}</content:encoded>
        </item>
        {{ end }}
    </channel>
</rss>